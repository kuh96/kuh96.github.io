title: 遠くの山は青く霞むか？
date: 2015-07-09 20:10
tags:
---

## カシミール３Ｄ

お使いの方も多いと思いますが、[カシミール３Ｄ][kashimir]というフリーかつ超優秀な３Ｄ地図ナビゲータがあります。ＤＡＮ杉本さんによる大変な労作で、わたしも以前から愛用しています。

[kashimir]:http://www.kashmir3d.com/index.html


このツールには単に３Ｄデータ地図を見るだけでなく、
地図データに基づいて **写真を撮影する** という素晴らしい機能があるのですが、
ちょっと計算がおかしいのでは、と思った部分があるのでちょっと書いてみます。

なお、**わたしの使い方が悪いだけなのかもしれませんが。。。**

## 遠くを青くかすませる

**青い山脈** **ブルーマウンテン** というくらいで、たしかに遠くの山は青くかすんだように見えますね。

カシミールの撮影にも、この遠くを青くかすませるという機能があるのですが、どうもこれがおかしいというか、思いどおりになってくれない。

カシミールのこの機能を使うと、どうも遠くが青くかすむだけでなく、全体的に暗くなり、特に **雪の白も青くなってしまう** 気がします。

以下の上段がサンプル画像ですが、右端の写真のように、雪はやっぱり白く写るし、実際目で見てもそう感じます。

 - 写真は3月初めの11時頃、竜ヶ岳山頂付近（富士山の北西約15km）よりのもの
 - カシミールの撮影もそれに合わせてある

なお下段は後述の **自家製改良版:青くかすませる** です。

<table>
<tr>
<td style="vertical-align:top;">
<b>カシミール:青くかすませない</b>
<img src="https://kuh96.github.io/images/bluesky-off.jpg" width="300">
<b>自家製改良版:青くかすませる</b>
<img src="https://kuh96.github.io/images/bluesky-conv01.jpg" width="300">
</td>

<td style="vertical-align:top;">
<b>カシミール:青くかすませる</b>
<img src="https://kuh96.github.io/images/bluesky-on.jpg" width="300">
</td>

<td style="vertical-align:top;">
<b>写真</b>
<img src="https://kuh96.github.io/images/bluesky-photo.jpg" width="300">
</td>
</tr>
</table>

 - なおカシミールのこの機能には、「視程」と「変化率」というパラメータがあり、
  それで「青くかすむ度合い」を変更できる
 - でもパラメータを変えても、やっぱりおかしい。。。

## 遠くの山が青くかすむ理由

遠くの山が青くかすむ理由について考えてみます。

青くなる原因は、空の青と同じく、空気による **レイリー散乱** によって、
光の青成分が赤成分より強く散乱されるため、と思われます。

まず直接光、すなわち雪山で反射された光が目に届く過程を考えてみます。

<img src="https://kuh96.github.io/images/blue-exp01.png" width="500">

でもこの場合は逆に **目に届く光は赤みがかるはず ** という結論になります。
（夕焼けが赤くなるのと同じ理由）

次に、日光が途中で空気によって散乱されて目に届く影響を考えてみます。

<img src="https://kuh96.github.io/images/blue-exp02.png" width="500">

空気による散乱光は、たしかに青みがかって目に届くようです。
おおよそ以下と考えられます。

 - 青みがかかる程度は、山から目までの距離（空気の厚さ）に比例する。
   すなわち遠いほど青みがかる。

 - 直接光＋日光の散乱による青成分のバイアス、が目に届く

 - しかし直接光が強い＝明るい物体の場合（例えば雪の白）、この青成分バイアスは直接光に比べて小さく、あまり目立たない

 - 逆に直接光が弱い＝暗い物体（例えば低層の樹林帯）、この青成分のバイアスは無視できず、青みがかって見える

## レイリー散乱の性質 ##

簡単にレイリー散乱の性質をまとめておきます。

 - 入射光の波長にくらべて十分小さな粒子による散乱。
   空気分子による散乱はこれに相当。

 - 散乱率は入射光の波長依存性が非常に強い。波長の4乗に反比例する。
   RGB でいえばおおむね R:G:B = 1:2:4

 - 散乱率の角度依存性は比較的小さい (1 + cos(Θ)^2)
   特に前方散乱 (Θ = 0..π/2) と後方散乱(Θ = π/2..π)の散乱率は同じ

なお別に **ミー散乱** といわれる要因があり、こちらは

 - 入射光の波長と同程度 or 大きな粒子による散乱。
   空気中の水滴（霧）や塵による散乱はこれに相当

 - 散乱率の入射光の波長依存性は弱い。すなわち散乱光は白い

 - 散乱率の角度依存性は大きく、特に前方散乱が強い

こちらのほうは、遠くほど全体に白っぽく（彩度が低く）なる原因です。

## 自家製改良版:青くかすませる

というわけで、[ごくごく簡単な改良版][sim]を作ってみました。
（改良になっているかはわかりませんが）

[sim]:https://kuh96.github.io/images/b8.html

 - 初体験の HTML5 Canvas を使用
 - 画像処理などもよく知らない

このため単純ですが、上のカシミール：青く霞ませない、
を原画像として以下の変換を行います。

15km と 60km のサンプルがありますが、60km ではほぼ真っ青になってしまいます。
適当にデフォルト値をセットするので、Reset Image してから Add Offset してみてください。

<dl>
<dt>decay(%s)<dt>
<dd>散乱による直接光の青成分の減衰率。
減衰後のB値＝ 元の B 値*(1- decay/100) で計算。
R:G:B = 1:2:4 として R,G 成分の減衰も同様に計算。

<dt>R, G, B</d>
<dd>間接光の散乱の影響で加わる光量。
入力値を上の減衰後のRGB値に単に加えます。
これもおおよそ 1:2:4 で指定すればよさそうです。

ミー散乱の効果を入れるには、RGBそれそれに +20 するなど
白色成分を加えてください。
</dd>
</dl>

えいや、で決めたデフォルト値で変換したのが以下の画像です。

- 15kme - Decay=10%, R=+10, G=+22, B=+48 

<img src="http://kuh96.github.io/images/bluesky-conv.png" width="300">

- 60km - Decay=50%, R=+50, G=+110, B=+240　b

<img src="http://kuh96.github.io/images/b8-conv.png" width="300">

多少もっともらしくなったような気がしますが、どうでしょうか？

 - 空もふくめて全体に青っぽくなるが、雪の白はそれほど変わらない
 - 原画像と比べると樹林の緑の部分は それなりに青くなって、いい感じ？

カシミールの処理はなんだかへんで、各画素に青成分を付加すれだけでよいのに、
付加する青成分が物体の明るさに依存した処理(convolution)になっているのでは、と推定しています。

## 空気の青！

結局、遠くの山が青く霞むのは、山から目までの空気が散乱した青い光を含むから、
と考えられます。すなわち **空気自体が青い** のです。

 - もちろん青さはごくわずかだけど、空気の厚さに比例して青くなる
 - 空の青の場合、この厚さは 10km くらい
 - でも「遠くの山」は視程がよければ 100km 以上でも見えるから、
   この青さは非常に強くなる

地球は青かった　→　（正しくは）空気は青かった、
ということになりますね。

## 参考

- https://en.wikipedia.org/wiki/Rayleigh_scattering
- http://hyperphysics.phy-astr.gsu.edu/hbase/atmos/blusky.html
-



